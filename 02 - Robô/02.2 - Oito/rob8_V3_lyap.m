%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% mobile robot control on a reference path 
%%% Victor Hugo, 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

clear all
close all
clc

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%           Coeficientes do controlador 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

pvar e1 e2 e4 e5
e_n=[e1;e2;e4;e5];
Ur = [0.3;-0.15];
ubar = Ur;
f = [Ur(1)*(e5+1); Ur(1)*e4; Ur(2)*(e5+1); -Ur(2)*e4];
g = [-1 e2; 0 -e1; 0 -e5-1; 0 e4];

n = size(f,2);
m = size(g,2);

% V inicial 

%z = monomials(e_n,1:2);
%V = z'*z;
V = e_n'*e_n
i = 0;
i_max = 100;
uo = ones(length(monomials(e_n,1:4)),m)*100;
while i<i_max
    % solving with SOSTOOLS (V fixed)
    prog = sosprogram(e_n);
    [prog,u1] = sospolyvar(prog,[monomials(e_n,1:4)],'wscoeff');
    [prog,u2] = sospolyvar(prog,[monomials(e_n,1:4)],'wscoeff');
    u=[u1;u2];
    [prog,l2] = sospolyvar(prog,[monomials(e_n,2:4)],'wscoeff');
    [prog,s1] = sospolyvar(prog, [monomials(e_n,2:4)],'wscoeff');
    g1 = e4^2+e5^2-1;
    % SOS constraints
    gradV = [diff(V,e1) diff(V,e2) diff(V,e4) diff(V,e5)];
    dV = -gradV*(f+g*(u+ubar))-s1*g1-l2;
    prog = sosineq(prog,dV);
    % first solution (u)
    sol = sossolve(prog);
    u = sosgetsol(sol,u);
    % solving with SOSTOOLS (u fixed)
    prog = sosprogram(e_n);
    [prog,V] = sospolyvar(prog,[monomials(e_n,2:4)],'wscoeff');
    [prog,l1] = sospolyvar(prog,[monomials(e_n,2:4)],'wscoeff');
    [prog,l2] = sospolyvar(prog,[monomials(e_n,2:4)],'wscoeff');
    [prog,s1] = sospolyvar(prog, [monomials(e_n,2:4)], 'wscoeff');

    g1 = e4^2+e5^2-1;
    % SOS constraints
    prog = sosineq(prog,V);
    gradV = [diff(V,e1) diff(V,e2) diff(V,e4) diff(V,e5)];
    dV = -gradV*(f+g*(u+ubar))-s1*g1-l2;
    prog = sosineq(prog,dV);
    prog = sosineq(prog,V-l1);
    % first solution (V)
    sol = sossolve(prog);
    V = sosgetsol(sol,V);
    delta_u = max(abs(full(u.coefficient)-uo))
    if delta_u<0.1
        break
    end
    uo = full(u.coefficient);
    i = i+1
end


%%
format long g     

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%            Inicializacao de Variveis
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Ts = 0.1;          % sampling time
Tsim = (2*pi*1)/Ts;   %90      % tempo de simula��o
h = 0.1;           % integrating time
D = 0.4;

xr = [1;1;0];  % x,y,theta referenciais para in�cio de trajet�ria. 
Xr = xr;         %Euler

Tsim = 85;
% The next loop difines the reference
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%           Geracao da trajetoria
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

for k = 1:round(Tsim/h)  % 1 a tempo de simula��o/ tempo de integra��o   
    vr(k) = 0.3;
    if k<= 419
        wr(k) = 0.15;
     else
         wr(k) = -0.15;
    end
    Xr = [Xr xr+h*([vr(k)*cos(xr(3));vr(k)*sin(xr(3));wr(k)])];  %Euler
    xr = Xr(:,k+1);
end
Ur = [vr;wr];
hold on
plot(Xr(1,:),Xr(2,:),'')


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                   Simulacao do robo.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

xo = [1;1.6;0];
x = xo;
X = x;
v = [];
w = [];
ubar = [0.3;0.15];
ubar2 = [0.3;-0.15];

for k = 1:round(Tsim/h)    % 1 a tempo de simula��o/ tempo de integra��o  
    
    a = Xr(:,k)-x;
    E1 = cos(x(3))*a(1)+sin(x(3))*a(1);
    E2 = -sin(x(3))*a(1)+cos(x(3))*a(2);
    E3 = a(3);
    E4 = sin(E3);
    E5 = cos(E3);
    
    if k<= 419
        v(k) = 4.766E-06*E1^4 - 7.8798E-05*E1^3*E2 + 0.00021114*E1^3*E4 - 7.3767E-06*E1^3*(E5-1) - 0.00020826*E1^2*E2^2 - 0.00088113*E1^2*E2*E4 + 0.00019991*E1^2*E2*(E5-1) + 0.0019118*E1^2*E4^2 - 0.00022155*E1^2*E4*(E5-1) + 1.4053E-05*E1^2*(E5-1)^2 - 4.3535E-05*E1*E2^3 + 7.8082E-05*E1*E2^2*E4 - 0.00039682*E1*E2^2*(E5-1) - 0.00012719*E1*E2*E4^2 + 0.0022086*E1*E2*E4*(E5-1) - 0.00036247*E1*E2*(E5-1)^2 + 0.00015073*E1*E4^3 - 0.00061309*E1*E4^2*(E5-1) + 0.00041873*E1*E4*(E5-1)^2 - 4.6242E-06*E1*(E5-1)^3 - 3.4563E-05*E2^4 + 7.9739E-05*E2^3*E4 - 2.7072E-06*E2^3*(E5-1) - 5.4616E-05*E2^2*E4^2 + 5.6814E-05*E2^2*E4*(E5-1) + 0.00040276*E2^2*(E5-1)^2 + 3.7161E-05*E2*E4^3 - 9.8655E-06*E2*E4^2*(E5-1) - 0.00022375*E2*E4*(E5-1)^2 + 0.00019932*E2*(E5-1)^3 + 2.8879E-05*E4^4 - 1.2998E-05*E4^3*(E5-1) - 5.825E-05*E4^2*(E5-1)^2 + 2.2782E-05*E4*(E5-1)^3 + 8.8444E-07*(E5-1)^4 + 0.62419*E1^3 - 0.005656*E1^2*E2 - 0.0056862*E1^2*E4 + 0.010552*E1^2*(E5-1) + 0.67643*E1*E2^2 - 0.38383*E1*E2*E4 + 0.021135*E1*E2*(E5-1) + 1.1401*E1*E4^2 - 0.022324*E1*E4*(E5-1) + 0.7649*E1*(E5-1)^2 - 0.014399*E2^3 - 0.0028875*E2^2*E4 - 0.18751*E2^2*(E5-1) - 0.015942*E2*E4^2 + 0.3661*E2*E4*(E5-1) + 0.032277*E2*(E5-1)^2 + 0.0011805*E4^3 + 0.19681*E4^2*(E5-1) - 0.050251*E4*(E5-1)^2 + 0.21642*(E5-1)^3 + 0.52726*E1^2 - 0.016739*E1*E2 - 0.0036089*E1*E4 + 0.17793*E1*(E5-1) + 0.07085*E2^2 + 0.098342*E2*E4 - 0.01622*E2*(E5-1) + 0.14571*E4^2 - 0.011694*E4*(E5-1) - 0.040687*(E5-1)^2 + 0.44062*E1 - 0.020397*E2 - 0.029241*E4 + 0.23774*(E5-1) + ubar(1);
        w(k) = -0.00016693*E1^4 + 0.0029667*E1^3*E2 - 0.0046743*E1^3*E4 + 0.0004205*E1^3*(E5-1) + 0.0001417*E1^2*E2^2 - 0.00054011*E1^2*E2*E4 - 0.0081933*E1^2*E2*(E5-1) + 0.00010192*E1^2*E4^2 + 0.0091947*E1^2*E4*(E5-1) - 0.00051402*E1^2*(E5-1)^2 + 0.0024852*E1*E2^3 - 0.0034664*E1*E2^2*E4 - 0.00070584*E1*E2^2*(E5-1) - 0.0001813*E1*E2*E4^2 + 0.0012607*E1*E2*E4*(E5-1) + 0.010851*E1*E2*(E5-1)^2 - 0.0010305*E1*E4^3 - 0.00023877*E1*E4^2*(E5-1) - 0.009551*E1*E4*(E5-1)^2 + 0.00014342*E1*(E5-1)^3 + 6.2776E-05*E2^4 + 4.6052E-05*E2^3*E4 - 0.0016107*E2^3*(E5-1) - 0.00012735*E2^2*E4^2 - 0.0017716*E2^2*E4*(E5-1) + 0.00042299*E2^2*(E5-1)^2 - 4.6408E-06*E2*E4^3 + 0.00137*E2*E4^2*(E5-1) - 0.00018642*E2*E4*(E5-1)^2 - 0.0046385*E2*(E5-1)^3 + 8.0967E-06*E4^4 + 0.00023341*E4^3*(E5-1) - 0.00013388*E4^2*(E5-1)^2 - 0.00053667*E4*(E5-1)^3 + 3.6482E-05*(E5-1)^4 + 0.026077*E1^3 + 0.50953*E1^2*E2 - 0.90455*E1^2*E4 + 0.019126*E1^2*(E5-1) + 0.016553*E1*E2^2 - 0.0039598*E1*E2*E4 - 0.43292*E1*E2*(E5-1) + 0.016616*E1*E4^2 - 0.35019*E1*E4*(E5-1) + 0.055392*E1*(E5-1)^2 + 0.75443*E2^3 - 0.49713*E2^2*E4 + 0.019394*E2^2*(E5-1) - 0.28101*E2*E4^2 - 0.0345*E2*E4*(E5-1) - 0.28285*E2*(E5-1)^2 - 0.5218*E4^3 - 0.0094122*E4^2*(E5-1) - 0.89649*E4*(E5-1)^2 + 0.0088086*(E5-1)^3 - 0.016553*E1^2 - 0.11345*E1*E2 + 0.1227*E1*E4 - 0.0081767*E1*(E5-1) - 0.0044844*E2^2 - 0.037076*E2*E4 + 0.087059*E2*(E5-1) + 0.0064805*E4^2 + 0.070155*E4*(E5-1) - 0.014089*(E5-1)^2 - 0.038143*E1 + 1.0003*E2 + 1.5197*E4 - 0.0075185*(E5-1) + ubar(2);

        %v(k) = 0.011751*E1^4 - 0.014981*E1^3*E2 + 0.023646*E1^3*E4 - 0.017585*E1^3*(E5-1) - 0.039129*E1^2*E2^2 + 0.0072761*E1^2*E2*E4 + 0.035895*E1^2*E2*(E5-1) + 0.0082737*E1^2*E4^2 - 0.017057*E1^2*E4*(E5-1) + 0.010251*E1^2*(E5-1)^2- 0.0077209*E1*E2^3 + 0.0093433*E1*E2^2*E4 + 0.041544*E1*E2^2*(E5-1)- 0.0079553*E1*E2*E4^2 - 0.0415*E1*E2*E4*(E5-1) - 0.034209*E1*E2*(E5-1)^2 + 0.0011216*E1*E4^3 + 0.016089*E1*E4^2*(E5-1) + 0.014378*E1*E4*(E5-1)^2 + 0.00021588*E1*(E5-1)^3 - 0.00097925*E2^4 + 0.001035*E2^3*E4 + 0.0037393*E2^3*(E5-1) + 0.0017502*E2^2*E4^2 + 4.0368E-05*E2^2*E4*(E5-1) - 0.0067332*E2^2*(E5-1)^2 - 0.0022532*E2*E4^3 - 0.0048266*E2*E4^2*(E5-1) + 0.0023786*E2*E4*(E5-1)^2 + 0.0053661*E2*(E5-1)^3 + 0.00055232*E4^4 + 0.0015185*E4^3*(E5-1) + 0.0015143*E4^2*(E5-1)^2 - 0.00014123*E4*(E5-1)^3 - 0.000498*(E5-1)^4 + 1.4377*E1^3 - 0.052845*E1^2*E2 - 0.12754*E1^2*E4 + 0.49848*E1^2*(E5-1) + 1.086*E1*E2^2 - 0.71005*E1*E2*E4 - 0.41035*E1*E2*(E5-1) + 0.84295*E1*E4^2 + 0.049632*E1*E4*(E5-1) + 0.76576*E1*(E5-1)^2 - 0.067086*E2^3 + 0.15633*E2^2*E4 + 0.27455*E2^2*(E5-1) - 0.15189*E2*E4^2 + 0.11924*E2*E4*(E5-1) - 0.18436*E2*(E5-1)^2 + 0.067513*E4^3 + 0.068225*E4^2*(E5-1) - 0.087485*E4*(E5-1)^2 + 0.031844*(E5-1)^3 + 1.2841*E1^2 - 0.064494*E1*E2 + 0.010571*E1*E4 + 0.18947*E1*(E5-1) - 0.59139*E2^2 - 0.17968*E2*E4 - 0.10528*E2*(E5-1) - 0.17962*E4^2 + 0.0061217*E4*(E5-1) - 0.23424*(E5-1)^2 + 0.9838*E1 - 0.093041*E2 - 0.035403*E4 + 0.31745*(E5-1) + ubar(1);
        %w(k) = -0.041195*E1^4 + 0.07*E1^3*E2 - 0.060717*E1^3*E4 + 0.055981*E1^3*(E5-1) + 0.081165*E1^2*E2^2 - 0.064596*E1^2*E2*E4 - 0.12125*E1^2*E2*(E5-1) + 0.00709*E1^2*E4^2 + 0.07881*E1^2*E4*(E5-1) - 0.02894*E1^2*(E5-1)^2 + 0.05508*E1*E2^3 - 0.033653*E1*E2^2*E4 - 0.11353*E1*E2^2*(E5-1) + 0.0073007*E1*E2*E4^2 + 0.065174*E1*E2*E4*(E5-1) + 0.097729*E1*E2*(E5-1)^2 - 0.001312*E1*E4^3 - 0.0063782*E1*E4^2*(E5-1) - 0.043431*E1*E4*(E5-1)^2 - 0.00061677*E1*(E5-1)^3 + 0.0011588*E2^4 + 0.0035888*E2^3*E4 - 0.012864*E2^3*(E5-1) - 0.0011483*E2^2*E4^2 - 0.0070176*E2^2*E4*(E5-1) + 0.022662*E2^2*(E5-1)^2 + 0.0011477*E2*E4^3 + 0.0046681*E2*E4^2*(E5-1) + 0.0035203*E2*E4*(E5-1)^2 - 0.016356*E2*(E5-1)^3 - 0.00027773*E4^4 - 0.0017656*E4^3*(E5-1) - 0.0036643*E4^2*(E5-1)^2 - 0.00052037*E4*(E5-1)^3 + 0.0014385*(E5-1)^4 + 0.096801*E1^3 + 1.8512*E1^2*E2 - 0.40531*E1^2*E4 - 0.31808*E1^2*(E5-1) + 0.10117*E1*E2^2 - 0.094966*E1*E2*E4 + 0.070647*E1*E2*(E5-1) - 0.11914*E1*E4^2 + 0.029124*E1*E4*(E5-1) + 0.036163*E1*(E5-1)^2 + 1.1852*E2^3 - 0.42749*E2^2*E4 - 0.3695*E2^2*(E5-1) + 0.027009*E2*E4^2 + 0.012438*E2*E4*(E5-1) + 0.087565*E2*(E5-1)^2 - 0.65563*E4^3 + 0.31663*E4^2*(E5-1) - 1.0539*E4*(E5-1)^2 + 0.081491*(E5-1)^3 - 0.14006*E1^2 + 0.20486*E1*E2 + 0.19329*E1*E4 + 0.080676*E1*(E5-1) - 0.013825*E2^2 - 0.051452*E2*E4 + 0.14257*E2*(E5-1) + 0.0014533*E4^2 - 0.069604*E4*(E5-1) - 0.0056507*(E5-1)^2 - 0.14027*E1 + 1.5205*E2 + 1.3846*E4 - 0.14621*(E5-1) + ubar(2);

    else
        v(k) = -2.9053E-07*E1^4 - 8.4779E-06*E1^3*E2 + 0.00015375*E1^3*E4 + 3.7786E-06*E1^3*(E5-1) - 0.00095916*E1^2*E2^2 - 0.0024698*E1^2*E2*E4 - 1.4989E-06*E1^2*E2*(E5-1) + 0.0063717*E1^2*E4^2 - 3.0768E-05*E1^2*E4*(E5-1) - 3.9752E-06*E1^2*(E5-1)^2 + 2.7662E-05*E1*E2^3 - 7.2316E-05*E1*E2^2*E4 - 0.00024505*E1*E2^2*(E5-1) - 6.1907E-05*E1*E2*E4^2 + 0.0050815*E1*E2*E4*(E5-1) - 9.0211E-05*E1*E2*(E5-1)^2 + 0.00012707*E1*E4^3 - 0.00094174*E1*E4^2*(E5-1) + 0.0001565*E1*E4*(E5-1)^2 + 3.6394E-06*E1*(E5-1)^3 - 6.9487E-05*E2^4 + 0.00014996*E2^3*E4 - 4.1626E-05*E2^3*(E5-1) - 7.3922E-05*E2^2*E4^2 + 2.0383E-05*E2^2*E4*(E5-1) + 0.00067349*E2^2*(E5-1)^2 + 9.0163E-05*E2*E4^3 + 1.8548E-05*E2*E4^2*(E5-1) - 0.00038196*E2*E4*(E5-1)^2 + 7.1987E-05*E2*(E5-1)^3 + 7.6961E-05*E4^4 - 7.4494E-06*E4^3*(E5-1) - 8.8035E-05*E4^2*(E5-1)^2 + 7.2969E-06*E4*(E5-1)^3 + 3.5293E-06*(E5-1)^4 + 0.64144*E1^3 - 0.0077651*E1^2*E2 - 0.011184*E1^2*E4 + 0.071437*E1^2*(E5-1) + 0.64413*E1*E2^2 - 0.47558*E1*E2*E4 + 0.0056561*E1*E2*(E5-1) + 1.1031*E1*E4^2 - 0.0055067*E1*E4*(E5-1) + 0.78697*E1*(E5-1)^2 + 0.0065573*E2^3 + 0.0043229*E2^2*E4 - 0.24145*E2^2*(E5-1) + 0.0028807*E2*E4^2 + 0.29835*E2*E4*(E5-1) + 0.013308*E2*(E5-1)^2 + 0.0017956*E4^3 + 0.25412*E4^2*(E5-1) - 0.0171*E4*(E5-1)^2 + 0.21989*(E5-1)^3 + 0.51255*E1^2 - 0.017492*E1*E2 + 0.008283*E1*E4 + 0.1877*E1*(E5-1) + 0.018686*E2^2 + 0.068696*E2*E4 + 0.0050404*E2*(E5-1) + 0.14405*E4^2 + 0.0073761*E4*(E5-1) - 0.019164*(E5-1)^2 + 0.42201*E1 - 0.014345*E2 + 0.014267*E4 + 0.24222*(E5-1) + ubar2(1);
        w(k) = -0.00015202*E1^4 + 0.0060346*E1^3*E2 - 0.009602*E1^3*E4 + 0.00025947*E1^3*(E5-1) + 9.633E-05*E1^2*E2^2 - 0.00027825*E1^2*E2*E4 - 0.010785*E1^2*E2*(E5-1) + 1.316E-05*E1^2*E4^2 + 0.0099627*E1^2*E4*(E5-1) - 0.00026737*E1^2*(E5-1)^2 + 0.002902*E1*E2^3 - 0.0040609*E1*E2^2*E4 - 0.0003301*E1*E2^2*(E5-1) - 0.00048505*E1*E2*E4^2 + 0.00066303*E1*E2*E4*(E5-1) + 0.011762*E1*E2*(E5-1)^2 - 0.00093035*E1*E4^3 - 0.00018689*E1*E4^2*(E5-1) - 0.010863*E1*E4*(E5-1)^2 + 9.3672E-05*E1*(E5-1)^3 + 2.9024E-05*E2^4 + 1.9752E-05*E2^3*E4 - 0.0017981*E2^3*(E5-1) - 6.8664E-05*E2^2*E4^2 - 0.0020252*E2^2*E4*(E5-1) + 0.00020341*E2^2*(E5-1)^2 + 1.3384E-05*E2*E4^3 + 0.0017027*E2*E4^2*(E5-1) - 0.00014294*E2*E4*(E5-1)^2 - 0.0050252*E2*(E5-1)^3 + 4.6218E-06*E4^4 + 0.00026649*E4^3*(E5-1) - 7.6808E-05*E4^2*(E5-1)^2 - 0.00045258*E4*(E5-1)^3 + 2.0788E-05*(E5-1)^4 + 0.015525*E1^3 + 0.64868*E1^2*E2 - 0.88197*E1^2*E4 + 0.016608*E1^2*(E5-1) - 0.0072579*E1*E2^2 - 0.021272*E1*E2*E4 - 0.31425*E1*E2*(E5-1) - 0.0025675*E1*E4^2 - 0.42705*E1*E4*(E5-1) + 0.025274*E1*(E5-1)^2 + 0.77289*E2^3 - 0.51161*E2^2*E4 + 0.0080767*E2^2*(E5-1) - 0.25728*E2*E4^2 - 0.0080581*E2*E4*(E5-1) - 0.27578*E2*(E5-1)^2 - 0.49779*E4^3 - 0.0026004*E4^2*(E5-1) - 0.8736*E4*(E5-1)^2 - 0.0025158*(E5-1)^3 - 0.0038499*E1^2 - 0.12122*E1*E2 + 0.10846*E1*E4 - 0.00028905*E1*(E5-1) + 0.0032977*E2^2 - 0.0043894*E2*E4 + 0.062722*E2*(E5-1) + 0.01147*E4^2 + 0.072873*E4*(E5-1) + 0.01343*(E5-1)^2 - 0.023712*E1 + 1.0318*E2 + 1.4787*E4 + 0.0081311*(E5-1) + ubar2(2);

        %v(k) = 0.00070986*E1^4 - 0.0028959*E1^3*E2 + 0.0040206*E1^3*E4 - 0.0019139*E1^3*(E5-1) - 0.0058622*E1^2*E2^2 - 0.0079258*E1^2*E2*E4 + 0.0098638*E1^2*E2*(E5-1) + 0.0059965*E1^2*E4^2 - 0.00544*E1^2*E4*(E5-1) + 0.00071895*E1^2*(E5-1)^2 + 0.00065626*E1*E2^3 + 0.0019714*E1*E2^2*E4 + 0.013104*E1*E2^2*(E5-1) - 0.0041752*E1*E2*E4^2 - 0.0085624*E1*E2*E4*(E5-1) - 0.0081008*E1*E2*(E5-1)^2 + 0.00099602*E1*E4^3 + 0.001836*E1*E4^2*(E5-1) + 0.0031022*E1*E4*(E5-1)^2 + 0.00036365*E1*(E5-1)^3 - 0.0036982*E2^4 + 0.0037668*E2^3*E4 + 0.00017395*E2^3*(E5-1) + 0.0033069*E2^2*E4^2 - 0.00022863*E2^2*E4*(E5-1) - 0.0007006*E2^2*(E5-1)^2 - 0.003554*E2*E4^3 + 0.00095951*E2*E4^2*(E5-1) - 0.00010517*E2*E4*(E5-1)^2 + 0.00032022*E2*(E5-1)^3 + 0.0005515*E4^4 - 0.00037516*E4^3*(E5-1) + 7.0244E-06*E4^2*(E5-1)^2 + 0.00041097*E4*(E5-1)^3 + 9.8169E-06*(E5-1)^4 + 0.8943*E1^3 - 0.02353*E1^2*E2 - 0.070194*E1^2*E4 + 0.18778*E1^2*(E5-1) + 0.69317*E1*E2^2 - 0.27598*E1*E2*E4 - 0.079749*E1*E2*(E5-1) + 0.8869*E1*E4^2 - 0.011734*E1*E4*(E5-1) + 0.77787*E1*(E5-1)^2 + 0.018389*E2^3 + 0.037082*E2^2*E4 + 0.13761*E2^2*(E5-1) + 0.027537*E2*E4^2 + 0.028291*E2*E4*(E5-1) - 0.06341*E2*(E5-1)^2 + 0.031102*E4^3 + 0.23464*E4^2*(E5-1) - 0.016755*E4*(E5-1)^2 + 0.10969*(E5-1)^3 + 0.60222*E1^2 - 0.069177*E1*E2 - 0.033736*E1*E4 - 0.060568*E1*(E5-1) - 0.1163*E2^2 - 0.38861*E2*E4 - 0.086516*E2*(E5-1) + 0.04974*E4^2 + 0.012005*E4*(E5-1) - 0.11163*(E5-1)^2 + 0.57952*E1 - 0.0097525*E2 - 0.037642*E4 + 0.19808*(E5-1) + ubar2(1); 
        %w(k) = -0.025785*E1^4 + 0.12911*E1^3*E2 - 0.083027*E1^3*E4 + 0.03634*E1^3*(E5-1) + 0.071888*E1^2*E2^2 - 0.042893*E1^2*E2*E4 - 0.2334*E1^2*E2*(E5-1) - 0.0049295*E1^2*E4^2 + 0.12432*E1^2*E4*(E5-1) - 0.010349*E1^2*(E5-1)^2 + 0.13282*E1*E2^3 - 0.035576*E1*E2^2*E4 - 0.082765*E1*E2^2*(E5-1) - 0.0092426*E1*E2*E4^2 + 0.018843*E1*E2*E4*(E5-1) + 0.13018*E1*E2*(E5-1)^2 - 1.5743E-06*E1*E4^3 + 0.0058576*E1*E4^2*(E5-1) - 0.049548*E1*E4*(E5-1)^2 - 0.0039866*E1*(E5-1)^3 + 0.00034159*E2^4 + 0.0045466*E2^3*E4 - 0.012024*E2^3*(E5-1) + 0.0016719*E2^2*E4^2 - 0.015593*E2^2*E4*(E5-1) + 0.013734*E2^2*(E5-1)^2 + 0.00018149*E2*E4^3 + 2.9527E-05*E2*E4^2*(E5-1) + 0.0057097*E2*E4*(E5-1)^2 - 0.016051*E2*(E5-1)^3 - 6.5006E-05*E4^4 - 0.0017435*E4^3*(E5-1) - 0.002152*E4^2*(E5-1)^2 - 0.0015439*E4*(E5-1)^3 + 0.000787*(E5-1)^4 - 0.05133*E1^3 + 1.004*E1^2*E2 - 0.40581*E1^2*E4 - 0.11861*E1^2*(E5-1) - 0.017508*E1*E2^2 + 0.062437*E1*E2*E4 + 0.20028*E1*E2*(E5-1) + 0.095963*E1*E4^2 - 0.20394*E1*E4*(E5-1) - 0.062615*E1*(E5-1)^2 + 0.7972*E2^3 + 0.21301*E2^2*E4 + 0.10966*E2^2*(E5-1) + 0.0061623*E2*E4^2 - 0.080814*E2*E4*(E5-1) + 0.16209*E2*(E5-1)^2 - 0.9549*E4^3 + 0.060503*E4^2*(E5-1) - 1.2273*E4*(E5-1)^2 + 0.1248*(E5-1)^3 - 0.047422*E1^2 + 0.040046*E1*E2 - 0.032128*E1*E4 + 0.022113*E1*(E5-1) - 0.010063*E2^2 - 0.026688*E2*E4 + 0.033569*E2*(E5-1) + 0.020868*E4^2 - 0.054999*E4*(E5-1) + 0.066712*(E5-1)^2 - 0.0065044*E1 + 0.8148*E2 + 1.9659*E4 - 0.042975*(E5-1) + ubar2(2);
    end

    if k>550 && k<555
        X = [X x+Ts*[v(k)*cos(x(3));v(k)*sin(x(3));w(k)]];
    else
        X = [X x+Ts*[v(k)*cos(x(3));v(k)*sin(x(3));w(k)]];
    end

    x = X(:,k+1);
    
    Erro(:,k) = Xr(:,k+1)- X(:,k+1);
    Erro4(k) = E4;
    Erro5(k) = E5;
   
end


plot(X(1,:),X(2,:),'r')
legend('rungeKutta','euler','trajet�ria do rob�')
xlabel('x[m]')
ylabel('y[m]')

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%      Plotagem de v e w 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

figure
ne = length(Erro);
tempo = Ts*(0:ne-1);
subplot(2,1,1)
plot(tempo,v,'b')
legend('v')

hold on
subplot(2,1,2)
plot (tempo,w,'r')
legend('w')

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%      Plotagem do erro x y e theta
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

figure
plot(tempo,Erro(1,:),tempo,Erro(2,:),tempo,Erro(3,:),tempo,Erro4(:),tempo,Erro5(:));
legend('x','y','theta')

 EE1 = Erro(1,:);
 EE2 = Erro(2,:);
 EE3 = Erro(3,:);