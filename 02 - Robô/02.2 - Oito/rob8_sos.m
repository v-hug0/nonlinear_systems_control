%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% mobile robot control on a reference path 
%%% Victor Hugo, 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

clear all
close all
clc

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%           Coeficientes do controlador 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

pvar e1 e2 e4 e5
e_n=[e1;e2;e4;e5];
Ur = [0.3 -0.15];
f = [Ur(1)*(e5+1); Ur(1)*e4; Ur(2)*(e5+1); -Ur(2)*e4];
g = [-1 e2; 0 -e1; 0 -e5-1; 0 e4];

n = size(f,2);
m = size(g,2);

% V inicial 

%z = monomials(e_n,1:2);
%V = z'*z;
V = e_n'*e_n
i = 0;
i_max = 10;
ubar = [0.3;-0.15];
gamma = 50;
while i<i_max
    % solving with SOSTOOLS (V fixed)
    %dpvar gamma;
    prog = sosprogram(e_n);
    %prog = sosdecvar(prog,gamma);
    [prog,u1] = sospolyvar(prog,[monomials(e_n,1:4)],'wscoeff');
    [prog,u2] = sospolyvar(prog,[monomials(e_n,1:4)],'wscoeff');
    u=[u1;u2];
    [prog,l2] = sospolyvar(prog,[monomials(e_n,2:4)],'wscoeff');
    [prog,s1] = sospolyvar(prog, [monomials(e_n,2:4)],'wscoeff');
    %[prog,s2] = sospolyvar(prog, [monomials(e_n,2:6)],'wscoeff');
    g1 = e4^2+e5^2-1;
    % SOS constraints
    gradV = [diff(V,e1) diff(V,e2) diff(V,e4) diff(V,e5)];
    dV = -gradV*(f+g*(u+ubar))-s1*g1-l2;
    prog = sosineq(prog,dV);
    %prog = sosineq(prog,gamma);
    %prog = sossetobj(prog,gamma);
    % first solution (k and s2)
    sol = sossolve(prog);
    u = sosgetsol(sol,u);
    %s2 = sosgetsol(sol,s2);
    %gamma = sosgetsol(sol,gamma)
    % solving with SOSTOOLS (k,s2 fixed)
    prog = sosprogram(e_n);
    [prog,V] = sospolyvar(prog,[monomials(e_n,2:4)],'wscoeff');
    [prog,l1] = sospolyvar(prog,[monomials(e_n,2:4)],'wscoeff');
    [prog,l2] = sospolyvar(prog,[monomials(e_n,2:4)],'wscoeff');
    [prog,s1] = sospolyvar(prog, [monomials(e_n,2:4)], 'wscoeff');
  
    g1 = e4^2+e5^2-1;
    % SOS constraints
    prog = sosineq(prog,V);
    gradV = [diff(V,e1) diff(V,e2) diff(V,e4) diff(V,e5)];
    dV = -gradV*(f+g*(u+ubar))-s1*g1-l2;
    prog = sosineq(prog,dV);
    prog = sosineq(prog,V-l1);
    %prog = sosineq(prog,T-l2);
    % first solution (V)
    sol = sossolve(prog);
    V = sosgetsol(sol,V);
    i = i+1
end

%%
format long g     

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%            Inicializacao de Variveis
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Ts = 0.1;          % sampling time
Tsim = (2*pi*1)/Ts;   %90      % tempo de simula��o
h = 0.1;           % integrating time
D = 0.4;

xr = [1;1;0];  % x,y,theta referenciais para in�cio de trajet�ria. 
Xr = xr;         %Euler

Tsim = 85;
% The next loop difines the reference
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%           Geracao da trajetoria
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

for k = 1:round(Tsim/h)  % 1 a tempo de simula��o/ tempo de integra��o   
    vr(k) = 0.3;
    if k<= 419
        wr(k) = 0.15;
     else
         wr(k) = -0.15;
    end
    Xr = [Xr xr+h*([vr(k)*cos(xr(3));vr(k)*sin(xr(3));wr(k)])];  %Euler
    xr = Xr(:,k+1);
end
Ur = [vr;wr];
hold on
plot(Xr(1,:),Xr(2,:),'')


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                   Simulacao do robo.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

xo = [0;0;0];
x = xo;
X = x;
v = [];
w = [];
ubar = [0.3;0.15];
ubar2 = [0.3;-0.15];

m = 0;
d = 0.000;
r = m + d.*randn(1,round(Tsim/h));

k1 = 2.6;
k2 = 1;
k3 = 3;

for k = 1:round(Tsim/h)    % 1 a tempo de simula��o/ tempo de integra��o  
    
    a = Xr(:,k)-x;
    E1 = cos(x(3))*a(1)+sin(x(3))*a(1);
    E2 = -sin(x(3))*a(1)+cos(x(3))*a(2);
    E3 = a(3);
    E4 = sin(E3);
    E5 = cos(E3);
    
    
    if k<= 419
        v(k) = 5.3986E-06*E1^4 - 0.00018713*E1^3*E2 + 0.00050283*E1^3*E4 - 1.0177E-05*E1^3*(E5-1) - 0.00093908*E1^2*E2^2 - 0.0022093*E1^2*E2*E4 + 0.00022935*E1^2*E2*(E5-1) + 0.0070132*E1^2*E4^2 - 0.00036225*E1^2*E4*(E5-1) - 1.6069E-06*E1^2*(E5-1)^2 - 3.5067E-05*E1*E2^3 + 1.3925E-05*E1*E2^2*E4 - 0.0002769*E1*E2^2*(E5-1) - 6.34E-06*E1*E2*E4^2 + 0.0055345*E1*E2*E4*(E5-1) - 0.00027489*E1*E2*(E5-1)^2 + 0.00040911*E1*E4^3 - 0.0010168*E1*E4^2*(E5-1) + 0.00026114*E1*E4*(E5-1)^2 - 9.6184E-07*E1*(E5-1)^3 - 6.1666E-05*E2^4 + 0.00014596*E2^3*E4 - 2.7388E-05*E2^3*(E5-1) - 4.2079E-05*E2^2*E4^2 + 0.0001038*E2^2*E4*(E5-1) + 0.00080061*E2^2*(E5-1)^2 + 6.4101E-05*E2*E4^3 + 6.8383E-05*E2*E4^2*(E5-1) - 0.00034468*E2*E4*(E5-1)^2 + 0.00011675*E2*(E5-1)^3 + 5.6074E-05*E4^4 - 1.776E-05*E4^3*(E5-1) - 6.0754E-05*E4^2*(E5-1)^2 + 6.4495E-06*E4*(E5-1)^3 + 3.2993E-06*(E5-1)^4 + 0.65248*E1^3 - 0.019029*E1^2*E2 - 0.0017118*E1^2*E4 + 0.03777*E1^2*(E5-1) + 0.63049*E1*E2^2 - 0.52568*E1*E2*E4 + 0.0056145*E1*E2*(E5-1) + 1.0644*E1*E4^2 + 0.013339*E1*E4*(E5-1) + 0.75596*E1*(E5-1)^2 - 0.01352*E2^3 - 0.0034599*E2^2*E4 - 0.26419*E2^2*(E5-1) - 0.0095768*E2*E4^2 + 0.29993*E2*E4*(E5-1) + 0.050223*E2*(E5-1)^2 - 0.0097238*E4^3 + 0.23239*E4^2*(E5-1) - 0.0049705*E4*(E5-1)^2 + 0.18207*(E5-1)^3 + 0.51378*E1^2 - 0.032094*E1*E2 + 0.012298*E1*E4 + 0.18194*E1*(E5-1) - 0.00038117*E2^2 + 0.093428*E2*E4 - 0.0065018*E2*(E5-1) + 0.13616*E4^2 - 0.01034*E4*(E5-1) - 0.028179*(E5-1)^2 + 0.44438*E1 - 0.02796*E2 - 0.031955*E4 + 0.24185*(E5-1) + ubar(1);
        w(k) = -0.00015851*E1^4 + 0.005429*E1^3*E2 - 0.0097355*E1^3*E4 + 0.00043347*E1^3*(E5-1) + 0.0001424*E1^2*E2^2 - 0.00048777*E1^2*E2*E4 - 0.0095331*E1^2*E2*(E5-1) - 0.0001385*E1^2*E4^2 + 0.0092627*E1^2*E4*(E5-1) - 0.00041788*E1^2*(E5-1)^2 + 0.0025396*E1*E2^3 - 0.0042783*E1*E2^2*E4 - 0.00028984*E1*E2^2*(E5-1) - 0.00021312*E1*E2*E4^2 + 0.0011262*E1*E2*E4*(E5-1) + 0.011074*E1*E2*(E5-1)^2 - 0.00083992*E1*E4^3 - 0.00045835*E1*E4^2*(E5-1) - 0.012097*E1*E4*(E5-1)^2 + 0.00030386*E1*(E5-1)^3 + 5.5707E-05*E2^4 - 6.4044E-05*E2^3*E4 - 0.0018009*E2^3*(E5-1) - 0.00015676*E2^2*E4^2 - 0.0016278*E2^2*E4*(E5-1) + 0.00030628*E2^2*(E5-1)^2 + 4.5438E-05*E2*E4^3 + 0.0017631*E2*E4^2*(E5-1) - 0.00058428*E2*E4*(E5-1)^2 - 0.0053584*E2*(E5-1)^3 - 3.147E-07*E4^4 + 7.9469E-05*E4^3*(E5-1) - 0.00019804*E4^2*(E5-1)^2 - 0.00021548*E4*(E5-1)^3 + 6.5559E-05*(E5-1)^4 + 0.022115*E1^3 + 0.66642*E1^2*E2 - 0.82713*E1^2*E4 + 0.0031329*E1^2*(E5-1) + 0.044042*E1*E2^2 - 0.024781*E1*E2*E4 - 0.28777*E1*E2*(E5-1) + 0.037269*E1*E4^2 - 0.36474*E1*E4*(E5-1) + 0.030545*E1*(E5-1)^2 + 0.78939*E2^3 - 0.46698*E2^2*E4 + 0.017435*E2^2*(E5-1) - 0.25433*E2*E4^2 - 0.027102*E2*E4*(E5-1) - 0.30706*E2*(E5-1)^2 - 0.49638*E4^3 - 0.030489*E4^2*(E5-1) - 0.82351*E4*(E5-1)^2 + 0.00016764*(E5-1)^3 - 0.034265*E1^2 - 0.14422*E1*E2 + 0.1114*E1*E4 + 0.0037939*E1*(E5-1) - 0.0015856*E2^2 - 0.039104*E2*E4 + 0.051491*E2*(E5-1) + 0.0026015*E4^2 + 0.076542*E4*(E5-1) + 0.00090279*(E5-1)^2 - 0.038854*E1 + 1.039*E2 + 1.4279*E4 - 0.0041658*(E5-1) + ubar(2);

    else
        v(k) = -9.4774E-07*E1^4 - 2.67E-05*E1^3*E2 - 0.00011825*E1^3*E4 + 1.0976E-05*E1^3*(E5-1) - 0.0008184*E1^2*E2^2 - 0.00075514*E1^2*E2*E4 - 0.0001172*E1^2*E2*(E5-1) + 0.0042452*E1^2*E4^2 - 0.00014529*E1^2*E4*(E5-1) - 1.0642E-05*E1^2*(E5-1)^2 + 2.6967E-05*E1*E2^3 + 7.0575E-05*E1*E2^2*E4 + 0.00011767*E1*E2^2*(E5-1) + 0.00011678*E1*E2*E4^2 + 0.0039606*E1*E2*E4*(E5-1) - 9.4375E-05*E1*E2*(E5-1)^2 - 4.7944E-05*E1*E4^3 - 0.00078024*E1*E4^2*(E5-1) + 0.00013638*E1*E4*(E5-1)^2 - 1.4221E-05*E1*(E5-1)^3 - 4.7221E-05*E2^4 + 0.00012122*E2^3*E4 - 8.1026E-06*E2^3*(E5-1) - 1.9092E-05*E2^2*E4^2 + 1.5584E-05*E2^2*E4*(E5-1) + 0.0005845*E2^2*(E5-1)^2 + 0.00016467*E2*E4^3 - 6.0911E-05*E2*E4^2*(E5-1) - 0.00040886*E2*E4*(E5-1)^2 + 3.7948E-05*E2*(E5-1)^3 + 3.4465E-05*E4^4 - 2.3578E-06*E4^3*(E5-1) - 0.00014577*E4^2*(E5-1)^2 + 1.393E-05*E4*(E5-1)^3 + 2.7298E-06*(E5-1)^4 + 0.59246*E1^3 - 0.013526*E1^2*E2 - 0.0039244*E1^2*E4 - 0.012925*E1^2*(E5-1) + 0.57793*E1*E2^2 - 0.14071*E1*E2*E4 - 0.020972*E1*E2*(E5-1) + 1.1283*E1*E4^2 + 0.026727*E1*E4*(E5-1) + 0.69502*E1*(E5-1)^2 + 0.0064535*E2^3 + 0.0033349*E2^2*E4 - 0.17508*E2^2*(E5-1) + 0.028331*E2*E4^2 + 0.36648*E2*E4*(E5-1) + 0.035624*E2*(E5-1)^2 + 0.0037291*E4^3 + 0.063397*E4^2*(E5-1) + 0.029509*E4*(E5-1)^2 + 0.19329*(E5-1)^3 + 0.58932*E1^2 - 0.020126*E1*E2 + 0.013275*E1*E4 + 0.10479*E1*(E5-1) + 0.1033*E2^2 + 0.24493*E2*E4 + 0.005291*E2*(E5-1) + 0.095799*E4^2 - 0.0044339*E4*(E5-1) - 0.058841*(E5-1)^2 + 0.44072*E1 - 0.019216*E2 + 0.0029057*E4 + 0.23585*(E5-1) + ubar2(1);
        w(k) = 0.00016428*E1^4 + 0.0037211*E1^3*E2 - 0.0068793*E1^3*E4 + 0.0001446*E1^3*(E5-1) - 7.4825E-05*E1^2*E2^2 - 0.00021629*E1^2*E2*E4 - 0.0071465*E1^2*E2*(E5-1) + 0.00042208*E1^2*E4^2 + 0.0062397*E1^2*E4*(E5-1) - 8.9038E-05*E1^2*(E5-1)^2 + 0.0019828*E1*E2^3 - 0.0036635*E1*E2^2*E4 + 0.00055225*E1*E2^2*(E5-1) + 6.5471E-05*E1*E2*E4^2 + 0.00034225*E1*E2*E4*(E5-1) + 0.0082002*E1*E2*(E5-1)^2 - 0.0012516*E1*E4^3 - 0.0005568*E1*E4^2*(E5-1) - 0.0078914*E1*E4*(E5-1)^2 + 0.00036383*E1*(E5-1)^3 - 2.8485E-05*E2^4 - 0.00011954*E2^3*E4 - 0.0016352*E2^3*(E5-1) - 4.3576E-05*E2^2*E4^2 - 0.0013052*E2^2*E4*(E5-1) - 0.00023717*E2^2*(E5-1)^2 + 7.4064E-05*E2*E4^3 + 0.0012397*E2*E4^2*(E5-1) - 0.00074992*E2*E4*(E5-1)^2 - 0.0042078*E2*(E5-1)^3 - 1.7518E-06*E4^4 + 0.00012274*E4^3*(E5-1) - 5.9529E-05*E4^2*(E5-1)^2 - 0.00069048*E4*(E5-1)^3 + 2.2053E-05*(E5-1)^4 + 0.0048541*E1^3 + 0.17189*E1^2*E2 - 0.89979*E1^2*E4 - 0.0016787*E1^2*(E5-1) + 0.004952*E1*E2^2 - 0.039075*E1*E2*E4 - 0.40639*E1*E2*(E5-1) - 0.011948*E1*E4^2 - 0.21931*E1*E4*(E5-1) - 0.0065956*E1*(E5-1)^2 + 0.81218*E2^3 - 0.58298*E2^2*E4 - 0.018854*E2^2*(E5-1) - 0.28496*E2*E4^2 - 0.018993*E2*E4*(E5-1) - 0.37557*E2*(E5-1)^2 - 0.57902*E4^3 + 0.0018482*E4^2*(E5-1) - 0.96031*E4*(E5-1)^2 - 0.0011167*(E5-1)^3 - 0.0039313*E1^2 - 0.21277*E1*E2 + 0.2259*E1*E4 + 0.028157*E1*(E5-1) + 0.0017627*E2^2 + 0.014621*E2*E4 + 0.069495*E2*(E5-1) + 0.0050483*E4^2 + 0.050201*E4*(E5-1) + 0.024683*(E5-1)^2 + 0.0053964*E1 + 1.0383*E2 + 1.5593*E4 + 0.0030437*(E5-1) + ubar2(2);
    end

    if k>550 && k<555
        X = [X x+r(k)+Ts*[v(k)*cos(x(3));v(k)*sin(x(3));w(k)]];
    else
        X = [X x+r(k)+Ts*[v(k)*cos(x(3));v(k)*sin(x(3));w(k)]];
    end

    x = X(:,k+1);
    
    Erro(:,k) = Xr(:,k+1)- X(:,k+1);
    Erro4(k) = E4;
    Erro5(k) = E5;
   
end


plot(X(1,:),X(2,:),'r')
legend('rungeKutta','euler','trajet�ria do rob�')
xlabel('x[m]')
ylabel('y[m]')

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%      Plotagem de v e w 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

figure
ne = length(Erro);
tempo = Ts*(0:ne-1);
subplot(2,1,1)
plot(tempo,v,'b')
legend('v')

hold on
subplot(2,1,2)
plot (tempo,w,'r')
legend('w')

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%      Plotagem do erro x y e theta
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

figure
plot(tempo,Erro(1,:),tempo,Erro(2,:),tempo,Erro(3,:),tempo,Erro4(:),tempo,Erro5(:));
legend('x','y','theta')

 EE1 = Erro(1,:);
 EE2 = Erro(2,:);
 EE3 = Erro(3,:);
