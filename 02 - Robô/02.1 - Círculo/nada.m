%%
format long g     

% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%            Inicializacao de Variveis
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Ts = 0.1;          % sampling time
Tsim = (2*pi*1)/Ts;   %90      % tempo de simula��o
h = 0.1;           % integrating time
D = 0.4;

%xr = [0.931386162550655; 1.388657897964; 1.98];  % x,y,theta referenciais para in�cio de trajet�ria. 
xr = [1;1;0];
Xr = xr;         %Euler

% The next loop difines the reference
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%           Geracao da trajetoria
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

for k = 1:round(Tsim/h)  % 1 a tempo de simula��o/ tempo de integra��o   
    vr(k) = 1;
    wr(k) = 1;
    Xr = [Xr xr+h*([vr(k)*cos(xr(3));vr(k)*sin(xr(3));wr(k)])];  %Euler
    xr = Xr(:,k+1);
end
Ur = [vr;wr];
hold on
plot(Xr(1,:),Xr(2,:),'')



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                   Simulacao do robo.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

xo = [0;0;0];
x = xo;
X = x;
v = [];
w = [];
ubar = [1;1];

m = 0;
d = 0.000;
r = m + d.*randn(1,round(Tsim/h));

for k = 1:(round(Tsim/h))    % 1 a tempo de simula��o/ tempo de integra��o  
    
    a = Xr(:,k)-x;
    E1 = cos(x(3))*a(1)+sin(x(3))*a(1);
    E2 = -sin(x(3))*a(1)+cos(x(3))*a(2);
    E3 = a(3);
    E4 = sin(E3);
    E5 = cos(E3);
  
    %THE BEST
    %v(k) = 0.013442*E1^4 - 0.019665*E1^3*E2 + 0.029614*E1^3*E4 - 0.025974*E1^3*(E5-1) - 0.041549*E1^2*E2^2 + 0.023613*E1^2*E2*(E5-1) + 0.021014*E1^2*E4^2 - 0.025727*E1^2*E4*(E5-1) + 0.015364*E1^2*(E5-1)^2 + 0.015864*E1*E2^2*E4 + 0.027221*E1*E2^2*(E5-1) - 0.020093*E1*E2*E4^2 - 0.016097*E1*E2*(E5-1)^2 + 0.67343*E1^3 - 0.25923*E1^2*E2 - 0.15171*E1^2*E4 + 0.33749*E1*E2^2 - 0.45396*E1*E2*E4 - 0.029917*E1*E2*(E5-1) + 0.4831*E1*E4^2 + 0.09248*E1*E4*(E5-1) + 0.34277*E1*(E5-1)^2 - 0.045804*E2^3 + 0.30128*E2^2*E4 - 0.17929*E2^2*(E5-1) - 0.10839*E2*E4^2 + 0.12175*E2*E4*(E5-1) + 0.098649*E2*(E5-1)^2 - 0.082531*E4^3 + 0.13755*E4^2*(E5-1) + 0.042982*E4*(E5-1)^2 + 0.091173*(E5-1)^3 + 0.83372*E1^2 - 0.1461*E1*E2 + 0.090158*E1*(E5-1) - 0.1035*E2^2 - 0.049459*E2*(E5-1) + 0.032868*E4^2 - 0.025278*E4*(E5-1) - 0.16313*(E5-1)^2 + 0.71108*E1 - 0.16272*E2 - 0.11674*E4 + 0.13231*(E5-1) + ubar(1);
    %w(k) = -0.029887*E1^4 + 0.072118*E1^3*E2 - 0.035325*E1^3*E4 + 0.041497*E1^3*(E5-1) + 0.01483*E1^2*E2^2 - 0.032196*E1^2*E2*E4 - 0.045756*E1^2*E2*(E5-1) - 0.016717*E1^2*(E5-1)^2 + 0.012312*E1*E2^3 - 0.017288*E1*E2^2*E4 - 0.012143*E1*E2^2*(E5-1) + 0.017947*E1*E2*E4^2 + 0.022851*E1*E2*E4*(E5-1) + 0.024671*E1*E2*(E5-1)^2 + 0.55256*E1^3 + 0.93828*E1^2*E2 - 0.3039*E1^2*E4 - 0.22142*E1^2*(E5-1) - 0.014085*E1*E2^2 + 0.024162*E1*E2*E4 - 0.31575*E1*E2*(E5-1) + 0.15547*E1*E4^2 - 0.10158*E1*E4*(E5-1) + 0.081527*E1*(E5-1)^2 + 0.75399*E2^3 - 0.22347*E2^2*E4 + 0.12089*E2^2*(E5-1) - 0.18799*E2*E4^2 - 0.12983*E2*E4*(E5-1) - 0.30545*E2*(E5-1)^2 - 0.092988*E4^3 - 0.29806*E4^2*(E5-1) - 0.3725*E4*(E5-1)^2 - 0.15794*(E5-1)^3 + 0.036311*E1^2 - 0.13594*E1*E2 + 0.11769*E1*E4 + 0.063842*E1*(E5-1) + 0.016413*E2^2 - 0.094787*E2*E4 + 0.027193*E2*(E5-1) + 0.040325*E4^2 + 0.041555*E4*(E5-1) + 0.11754*(E5-1)^2 - 0.14323*E1 + 1.1949*E2 + 0.9934*E4 + 0.10656*(E5-1) + ubar(2);

    %THE BEST (FILTERED)  --- results are very close
    %v(k) = 0.67343*E1^3 - 0.25923*E1^2*E2 - 0.15171*E1^2*E4 + 0.33749*E1*E2^2 - 0.45396*E1*E2*E4 + 0.4831*E1*E4^2 + 0.34277*E1*(E5-1)^2 + 0.30128*E2^2*E4 - 0.17929*E2^2*(E5-1) - 0.10839*E2*E4^2 + 0.12175*E2*E4*(E5-1) + 0.13755*E4^2*(E5-1) + 0.83372*E1^2 - 0.1461*E1*E2 - 0.1035*E2^2 - 0.16313*(E5-1)^2 + 0.71108*E1 - 0.16272*E2 - 0.11674*E4 + 0.13231*(E5-1) + ubar(1);
    %w(k) = 0.55256*E1^3 + 0.93828*E1^2*E2 - 0.3039*E1^2*E4 - 0.22142*E1^2*(E5-1) - 0.31575*E1*E2*(E5-1) + 0.15547*E1*E4^2 - 0.10158*E1*E4*(E5-1) + 0.75399*E2^3 - 0.22347*E2^2*E4 + 0.12089*E2^2*(E5-1) - 0.18799*E2*E4^2 - 0.12983*E2*E4*(E5-1) - 0.30545*E2*(E5-1)^2 - 0.29806*E4^2*(E5-1) - 0.3725*E4*(E5-1)^2 - 0.15794*(E5-1)^3 - 0.13594*E1*E2 + 0.11769*E1*E4 + 0.11754*(E5-1)^2 - 0.14323*E1 + 1.1949*E2 + 0.9934*E4 + 0.10656*(E5-1) + ubar(2);

    %v(k) = 0.022679*E1^4 + 0.023428*E1^3*E2 + 0.060221*E1^3*E4 - 0.014796*E1^3*(E5-1) - 0.07072*E1^2*E2^2 - 0.048277*E1^2*E2*E4 - 0.0029425*E1^2*E2*(E5-1) + 0.026879*E1^2*E4^2 - 0.016501*E1^2*E4*(E5-1) + 0.0049379*E1^2*(E5-1)^2 - 0.0090439*E1*E2^3 - 0.013502*E1*E2^2*E4 + 0.031065*E1*E2^2*(E5-1) - 0.012775*E1*E2*E4^2 + 0.0098654*E1*E2*E4*(E5-1) - 0.0091849*E1*E2*(E5-1)^2 + 0.0033585*E1*E4^3 - 0.004009*E1*E4^2*(E5-1) - 0.00030846*E1*E4*(E5-1)^2 - 2.8894E-05*E1*(E5-1)^3 - 6.9073E-05*E2^4 - 0.00032991*E2^3*E4 + 0.0025334*E2^3*(E5-1) - 0.001316*E2^2*E4^2 + 0.0020281*E2^2*E4*(E5-1) - 0.0034677*E2^2*(E5-1)^2 - 0.00045076*E2*E4^3 + 0.001667*E2*E4^2*(E5-1) - 0.0010074*E2*E4*(E5-1)^2 + 0.0018205*E2*(E5-1)^3 + 8.2562E-05*E4^4 - 0.00014535*E4^3*(E5-1) - 0.00023753*E4^2*(E5-1)^2 + 0.00016903*E4*(E5-1)^3 - 0.00021834*(E5-1)^4 + 0.63377*E1^3 + 0.11797*E1^2*E2 - 0.17067*E1^2*E4 - 0.032735*E1^2*(E5-1) + 0.59389*E1*E2^2 - 0.12065*E1*E2*E4 + 0.094889*E1*E2*(E5-1) + 0.2795*E1*E4^2 + 0.060938*E1*E4*(E5-1) + 0.36324*E1*(E5-1)^2 - 0.067703*E2^3 + 0.17016*E2^2*E4 + 0.033946*E2^2*(E5-1) + 0.025644*E2*E4^2 + 0.049392*E2*E4*(E5-1) + 0.019576*E2*(E5-1)^2 - 0.083759*E4^3 - 0.094921*E4^2*(E5-1) - 0.069397*E4*(E5-1)^2 - 0.0077285*(E5-1)^3 + 0.94075*E1^2 + 0.021785*E1*E2 + 0.046243*E1*E4 + 0.049291*E1*(E5-1) + 0.28182*E2^2 + 0.22786*E2*E4 - 0.0076298*E2*(E5-1) + 0.2202*E4^2 - 0.047299*E4*(E5-1) - 0.097279*(E5-1)^2 + 0.69754*E1 - 0.053633*E2 - 0.12827*E4 + 0.18276*(E5-1) + ubar(1);
    %w(k) = -0.084065*E1^4 + 0.10397*E1^3*E2 - 0.043461*E1^3*E4 + 0.031665*E1^3*(E5-1) + 0.013109*E1^2*E2^2 + 0.022022*E1^2*E2*E4 - 0.040742*E1^2*E2*(E5-1) - 0.01057*E1^2*E4^2 + 0.011835*E1^2*E4*(E5-1) - 0.0053815*E1^2*(E5-1)^2 + 0.0078426*E1*E2^3 - 0.00034521*E1*E2^2*E4 - 0.0038745*E1*E2^2*(E5-1) + 0.0073734*E1*E2*E4^2 - 0.0048454*E1*E2*E4*(E5-1) + 0.013511*E1*E2*(E5-1)^2 - 0.0018602*E1*E4^3 + 0.0014257*E1*E4^2*(E5-1) - 0.0024962*E1*E4*(E5-1)^2 - 0.00013949*E1*(E5-1)^3 + 0.00087367*E2^4 + 0.00026746*E2^3*E4 - 0.0011089*E2^3*(E5-1) + 0.00069883*E2^2*E4^2 + 1.7594E-05*E2^2*E4*(E5-1) + 0.0015514*E2^2*(E5-1)^2 + 0.00033788*E2*E4^3 - 0.00099626*E2*E4^2*(E5-1) + 0.00062091*E2*E4*(E5-1)^2 - 0.0014278*E2*(E5-1)^3 - 9.9931E-05*E4^4 + 7.9344E-05*E4^3*(E5-1) + 0.00013545*E4^2*(E5-1)^2 + 8.4911E-05*E4*(E5-1)^3 + 0.00035443*(E5-1)^4 + 0.14598*E1^3 - 0.66552*E1^2*E2 + 0.48661*E1^2*E4 - 0.19094*E1^2*(E5-1) - 0.2131*E1*E2^2 - 0.10649*E1*E2*E4 - 0.17653*E1*E2*(E5-1) + 0.15813*E1*E4^2 + 0.11582*E1*E4*(E5-1) + 0.23755*E1*(E5-1)^2 + 0.92623*E2^3 - 0.62134*E2^2*E4 + 0.33491*E2^2*(E5-1) - 0.31875*E2*E4^2 - 0.17727*E2*E4*(E5-1) - 0.43811*E2*(E5-1)^2 + 0.32168*E4^3 + 0.017083*E4^2*(E5-1) - 0.081435*E4*(E5-1)^2 - 0.039005*(E5-1)^3 - 0.10656*E1^2 + 0.23632*E1*E2 - 0.59375*E1*E4 + 0.16229*E1*(E5-1) + 0.014501*E2^2 - 0.0059766*E2*E4 + 0.12526*E2*(E5-1) + 0.032654*E4^2 - 0.067666*E4*(E5-1) + 0.11975*(E5-1)^2 - 0.18687*E1 + 1.3487*E2 + 0.9631*E4 + 0.08193*(E5-1) + ubar(2);

    
    v(k) = -0.0050973*E1^4 + 0.038267*E1^3*E2 + 0.0071696*E1^3*E4 + 0.011913*E1^3*(E5-1) - 0.013063*E1^2*E2^2 - 0.059192*E1^2*E2*E4 - 0.011194*E1^2*E2*(E5-1) - 0.010027*E1^2*E4^2 - 0.012052*E1^2*E4*(E5-1) - 0.011189*E1^2*(E5-1)^2 - 0.025969*E1*E2^3 + 0.022535*E1*E2^2*E4 - 0.026544*E1*E2^2*(E5-1) + 0.032729*E1*E2*E4^2 + 0.0043205*E1*E2*E4*(E5-1) - 0.0073466*E1*E2*(E5-1)^2 + 0.0075101*E1*E4^3 + 0.0051714*E1*E4^2*(E5-1) + 0.010027*E1*E4*(E5-1)^2 - 0.000175*E1*(E5-1)^3 - 2.4068E-05*E2^4 + 0.0090417*E2^3*E4 - 0.0013576*E2^3*(E5-1) - 0.00059123*E2^2*E4^2 + 0.0049751*E2^2*E4*(E5-1) + 0.0056068*E2^2*(E5-1)^2 - 0.006802*E2*E4^3 + 0.0062368*E2*E4^2*(E5-1) - 0.0029803*E2*E4*(E5-1)^2 + 0.005797*E2*(E5-1)^3 - 0.0021596*E4^4 + 0.0016337*E4^3*(E5-1) - 0.0027679*E4^2*(E5-1)^2 + 0.0013411*E4*(E5-1)^3 + 0.0020022*(E5-1)^4 + 2.1959*E1^3 + 0.22746*E1^2*E2 + 1.2948*E1^2*E4 - 0.06067*E1^2*(E5-1) + 0.38652*E1*E2^2 + 0.0045471*E1*E2*E4 - 0.41956*E1*E2*(E5-1) + 1.8203*E1*E4^2 + 0.30167*E1*E4*(E5-1) + 1.586*E1*(E5-1)^2 + 0.019691*E2^3 - 0.14687*E2^2*E4 - 0.23582*E2^2*(E5-1) + 0.30674*E2*E4^2 - 0.13482*E2*E4*(E5-1) + 0.2797*E2*(E5-1)^2 + 0.049388*E4^3 + 0.37237*E4^2*(E5-1) + 0.52972*E4*(E5-1)^2 + 0.11415*(E5-1)^3 + 1.6958*E1^2 - 0.097993*E1*E2 + 0.42105*E1*E4 - 0.3504*E1*(E5-1) - 0.62425*E2^2 - 0.19144*E2*E4 + 0.13537*E2*(E5-1) - 0.078572*E4^2 - 0.11852*E4*(E5-1) - 0.10201*(E5-1)^2 + 1.6464*E1 + 0.15451*E2 + 0.12518*E4 + 0.56361*(E5-1) + ubar(1);
    w(k) = -0.085834*E1^4 + 0.042031*E1^3*E2 + 0.18548*E1^3*E4 + 0.026801*E1^3*(E5-1) + 0.054055*E1^2*E2^2 - 0.084631*E1^2*E2*E4 + 0.036047*E1^2*E2*(E5-1) - 0.16932*E1^2*E4^2 - 0.0083642*E1^2*E4*(E5-1) - 0.0033644*E1^2*(E5-1)^2 + 0.0020219*E1*E2^3 - 0.047399*E1*E2^2*E4 + 0.0034378*E1*E2^2*(E5-1) + 0.059386*E1*E2*E4^2 - 0.033286*E1*E2*E4*(E5-1) + 0.008371*E1*E2*(E5-1)^2 + 0.074279*E1*E4^3 - 0.010661*E1*E4^2*(E5-1) + 0.0023638*E1*E4*(E5-1)^2 + 0.0019696*E1*(E5-1)^3 + 0.0051378*E2^4 - 0.0015368*E2^3*E4 + 0.0081664*E2^3*(E5-1) + 0.02306*E2^2*E4^2 - 0.011125*E2^2*E4*(E5-1) + 0.016481*E2^2*(E5-1)^2 - 0.015409*E2*E4^3 + 0.020115*E2*E4^2*(E5-1) - 0.01399*E2*E4*(E5-1)^2 + 0.011823*E2*(E5-1)^3 - 0.013017*E4^4 + 0.0098133*E4^3*(E5-1) - 0.00095033*E4^2*(E5-1)^2 + 0.0011707*E4*(E5-1)^3 + 0.003789*(E5-1)^4 - 0.45406*E1^3 + 0.25898*E1^2*E2 - 0.1644*E1^2*E4 - 0.45515*E1^2*(E5-1) + 0.13519*E1*E2^2 + 0.70012*E1*E2*E4 - 0.21406*E1*E2*(E5-1) - 0.72342*E1*E4^2 + 0.014562*E1*E4*(E5-1) - 0.61156*E1*(E5-1)^2 + 4.1129*E2^3 + 0.30872*E2^2*E4 - 1.6564*E2^2*(E5-1) + 0.046438*E2*E4^2 + 0.076675*E2*E4*(E5-1) - 0.02696*E2*(E5-1)^2 + 0.72704*E4^3 + 0.33709*E4^2*(E5-1) + 0.52808*E4*(E5-1)^2 + 0.19449*(E5-1)^3 - 0.54554*E1^2 + 0.0077779*E1*E2 - 0.094133*E1*E4 + 0.15673*E1*(E5-1) - 0.55987*E2^2 - 0.12359*E2*E4 + 0.30433*E2*(E5-1) + 0.13966*E4^2 + 0.28297*E4*(E5-1) + 0.14675*(E5-1)^2 + 0.057877*E1 + 2.4576*E2 + 1.4558*E4 - 0.10733*(E5-1) + ubar(2);
    
    % dissipatividade
    %v(k) = -0.0051738*E1^2 - 0.0021226*E1*E2 - 0.026702*E1*E3 + 0.2642*E1*E4 + 1.2022*E1*(E5-1) - 0.018476*E2^2 + 0.0083082*E2*E3 + 0.04823*E2*E4 + 0.016441*E2*(E5-1) - 0.0040279*E3^2 + 0.0065559*E3*E4 - 0.0061168*E3*(E5-1) - 0.023727*E4^2 - 0.013772*E4*(E5-1) - 0.046528*(E5-1)^2 + 4.0633*E1 - 0.50829*E2 + 0.1346*E3 + 0.08552*E4 - 0.060523*(E5-1) + ubar(1);
    %w(k) = 0.91726*E2^2 - 0.13194*E2*E3 - 0.070694*E2*E4 - 0.044194*E3^2 + 0.021534*E3*E4 + 0.016843*E4^2 - 0.016826*E2 + 3.5761*E3 + 0.91726*E4 + ubar(2);

    X = [X x+r(k)+Ts*[v(k)*cos(x(3));v(k)*sin(x(3));w(k)]];
    x = X(:,k+1);
    
    Erro(:,k) = Xr(:,k+1)- X(:,k+1);
   
end


plot(X(1,:),X(2,:),'r')
legend('rungeKutta','trajetoria do robo')
xlabel('x[m]')
ylabel('y[m]')

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%      Plotagem de v e w 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

figure
ne = length(Erro);
tempo = Ts*(0:ne-1);
subplot(2,1,1)
plot(tempo,v,'b')
legend('v')

hold on
subplot(2,1,2)
plot (tempo,w,'r')
legend('w')

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%      Plotagem do erro x y e theta
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

figure
plot(tempo,Erro(1,:),tempo,Erro(2,:),tempo,Erro(3,:));
legend('x','y','theta')

 EE1 = Erro(1,:);
 EE2 = Erro(2,:);
 EE3 = Erro(3,:);